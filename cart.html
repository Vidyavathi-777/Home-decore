<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart - Home Decore</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        .navbar-brand {
            font-weight: 700;
            color: #5D4037;
        }
        .cart-container {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 20px;
            margin-top: 20px;
        }
        .cart-header {
            border-bottom: 1px solid #e0e0e0;
            padding-bottom: 15px;
            margin-bottom: 20px;
        }
        .cart-item {
            border-bottom: 1px solid #f0f0f0;
            padding: 15px 0;
        }
        .cart-item:last-child {
            border-bottom: none;
        }
        .product-img {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 6px;
        }
        .product-name {
            font-weight: 600;
            color: #333;
        }
        .product-price {
            color: #777;
            font-size: 14px;
        }
        .qty-input {
            width: 60px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 5px;
        }
        .remove-btn {
            color: #dc3545;
            background: none;
            border: none;
            cursor: pointer;
        }
        .checkout-section {
            background-color: #f9f9f9;
            border-radius: 8px;
            padding: 20px;
        }
        .total-price {
            font-size: 24px;
            font-weight: 700;
            color: #5D4037;
        }
        .checkout-btn {
            background-color: #5D4037;
            border: none;
            color: white;
            padding: 12px 30px;
            font-weight: 600;
            border-radius: 4px;
            margin-top: 15px;
        }
        .checkout-btn:hover {
            background-color: #4E342E;
        }
        .continue-shopping {
            color: #5D4037;
            text-decoration: none;
            display: inline-block;
            margin-top: 15px;
        }
        .continue-shopping:hover {
            color: #4E342E;
            text-decoration: underline;
        }
        .empty-cart {
            text-align: center;
            padding: 50px 0;
        }
        .empty-cart i {
            font-size: 70px;
            color: #d0d0d0;
            margin-bottom: 20px;
        }
        .quantity-controls {
            display: flex;
            align-items: center;
        }
        .qty-btn {
            background: #f0f0f0;
            border: none;
            width: 28px;
            height: 28px;
            border-radius: 4px;
            font-weight: bold;
            cursor: pointer;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255,255,255,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .spinner-border {
            width: 3rem;
            height: 3rem;
        }
    </style>
</head>
<body>
    <!-- Loading Spinner -->
    <div class="loading" id="loadingSpinner">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light">
        <div class="container">
            <a class="navbar-brand" href="index.html">Home Decore</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">Home</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="products.html">Products</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="categories.html">Categories</a>
                    </li>
                </ul>
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="orders.html">
                            <i class="fas fa-box"></i> Orders
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="cart.html">
                            <i class="fas fa-shopping-cart"></i> Cart
                            <span class="badge bg-danger" id="cartCount">0</span>
                        </a>
                    </li>
                    <li class="nav-item" id="loginNavItem">
                        <a class="nav-link" href="login.html">
                            <i class="fas fa-sign-in-alt"></i> Login
                        </a>
                    </li>
                    <li class="nav-item dropdown d-none" id="userDropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="userDropdownToggle" role="button" data-bs-toggle="dropdown">
                            <i class="fas fa-user-circle"></i> <span id="username">User</span>
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end">
                            <li><a class="dropdown-item" href="profile.html">My Profile</a></li>
                            <li><a class="dropdown-item" href="orders.html">My Orders</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" id="logoutBtn">Logout</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-5">
        <div class="row">
            <div class="col-lg-8">
                <div class="cart-container">
                    <div class="cart-header">
                        <h2>Shopping Cart</h2>
                    </div>
                    
                    <div id="cartItems">
                        <!-- Cart items will be loaded here dynamically -->
                    </div>
                    
                    <div id="emptyCartMessage" class="empty-cart d-none">
                        <i class="fas fa-shopping-cart"></i>
                        <h3>Your cart is empty</h3>
                        <p>Looks like you haven't added any products to your cart yet.</p>
                        <a href="products.html" class="btn btn-outline-primary mt-3">
                            <i class="fas fa-arrow-left me-2"></i>Continue Shopping
                        </a>
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="checkout-section" id="checkoutSection">
                    <h4>Order Summary</h4>
                    <div class="d-flex justify-content-between mt-4">
                        <span>Subtotal:</span>
                        <span id="subtotal">$0.00</span>
                    </div>
                    <div class="d-flex justify-content-between mt-2">
                        <span>Shipping:</span>
                        <span id="shipping">$0.00</span>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between">
                        <span class="fw-bold">Total:</span>
                        <span class="total-price" id="totalPrice">$0.00</span>
                    </div>
                    <button class="btn checkout-btn w-100" id="checkoutBtn">
                        Proceed to Checkout
                    </button>
                    <a href="products.html" class="continue-shopping">
                        <i class="fas fa-arrow-left me-2"></i>Continue Shopping
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-dark text-white py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-4">
                    <h5>Home Decore</h5>
                    <p>Your one-stop shop for beautiful home decoration items and furniture.</p>
                </div>
                <div class="col-md-4">
                    <h5>Quick Links</h5>
                    <ul class="list-unstyled">
                        <li><a href="index.html" class="text-white">Home</a></li>
                        <li><a href="products.html" class="text-white">Products</a></li>
                        <li><a href="categories.html" class="text-white">Categories</a></li>
                        <li><a href="about.html" class="text-white">About Us</a></li>
                        <li><a href="contact.html" class="text-white">Contact</a></li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <h5>Contact Us</h5>
                    <address>
                        <p><i class="fas fa-map-marker-alt me-2"></i>123 Decor Street, Design City</p>
                        <p><i class="fas fa-phone-alt me-2"></i>(123) 456-7890</p>
                        <p><i class="fas fa-envelope me-2"></i>info@homedecore.com</p>
                    </address>
                    <div class="social-icons">
                        <a href="#" class="text-white me-2"><i class="fab fa-facebook-f"></i></a>
                        <a href="#" class="text-white me-2"><i class="fab fa-twitter"></i></a>
                        <a href="#" class="text-white me-2"><i class="fab fa-instagram"></i></a>
                        <a href="#" class="text-white"><i class="fab fa-pinterest"></i></a>
                    </div>
                </div>
            </div>
            <hr>
            <div class="text-center">
                <p class="mb-0">&copy; 2025 Home Decore. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Bootstrap & JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API URL
        const API_BASE_URL = 'http://localhost:8000';
        
        // DOM Elements
        const cartItemsContainer = document.getElementById('cartItems');
        const emptyCartMessage = document.getElementById('emptyCartMessage');
        const checkoutSection = document.getElementById('checkoutSection');
        const subtotalElement = document.getElementById('subtotal');
        const shippingElement = document.getElementById('shipping');
        const totalPriceElement = document.getElementById('totalPrice');
        const checkoutBtn = document.getElementById('checkoutBtn');
        const cartCountElement = document.getElementById('cartCount');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginNavItem = document.getElementById('loginNavItem');
        const userDropdown = document.getElementById('userDropdown');
        const usernameElement = document.getElementById('username');

        // Check Authentication
        function checkAuth() {
            const token = localStorage.getItem('token');
            if (token) {
                loginNavItem.classList.add('d-none');
                userDropdown.classList.remove('d-none');
                const user = JSON.parse(localStorage.getItem('user'));
                if (user) {
                    usernameElement.textContent = user.username || 'User';
                }
                return true;
            } else {
                window.location.href = 'login.html';
                return false;
            }
        }

        // Logout Function
        logoutBtn.addEventListener('click', function(e) {
            e.preventDefault();
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        });

        // Show Loading Spinner
        function showLoading() {
            loadingSpinner.classList.remove('d-none');
        }

        // Hide Loading Spinner
        function hideLoading() {
            loadingSpinner.classList.add('d-none');
        }

        // Format Currency
        function formatCurrency(amount) {
            return '$' + parseFloat(amount).toFixed(2);
        }

        // Fetch Cart Items
        async function fetchCart() {
            if (!checkAuth()) return;
            
            showLoading();
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/cart`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch cart');
                }

                const data = await response.json();
                displayCart(data);
                updateCartCount(data.cart.length);
            } catch (error) {
                console.error('Error fetching cart:', error);
                showToast('Error loading cart data. Please try again.', 'danger');
            } finally {
                hideLoading();
            }
        }

        // Display Cart Items
        function displayCart(data) {
            const cartItems = data.cart;
            const totalAmount = data.total;
            
            if (cartItems.length === 0) {
                emptyCartMessage.classList.remove('d-none');
                checkoutSection.classList.add('d-none');
                cartItemsContainer.innerHTML = '';
                return;
            }

            emptyCartMessage.classList.add('d-none');
            checkoutSection.classList.remove('d-none');
            
            let html = '';
            
            cartItems.forEach(item => {
                html += `
                <div class="cart-item" data-id="${item.product_id}">
                    <div class="row align-items-center">
                        <div class="col-md-2">
                            <img src="${item.image || 'images/placeholder.jpg'}" class="product-img" alt="${item.name}">
                        </div>
                        <div class="col-md-4">
                            <h5 class="product-name">${item.name}</h5>
                            <p class="product-price">${formatCurrency(item.price)} each</p>
                        </div>
                        <div class="col-md-3">
                            <div class="quantity-controls">
                                <button class="qty-btn decrease-qty" data-id="${item.product_id}">-</button>
                                <input type="number" class="qty-input mx-2" value="${item.quantity}" min="1" data-id="${item.product_id}" readonly>
                                <button class="qty-btn increase-qty" data-id="${item.product_id}">+</button>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <h6>${formatCurrency(item.item_total)}</h6>
                        </div>
                        <div class="col-md-1 text-end">
                            <button class="remove-btn" data-id="${item.product_id}">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>
                `;
            });
            
            cartItemsContainer.innerHTML = html;
            
            // Calculate shipping (free over $50, otherwise $5)
            const shippingCost = totalAmount > 50 ? 0 : 5;
            const finalTotal = totalAmount + shippingCost;
            
            // Update summary
            subtotalElement.textContent = formatCurrency(totalAmount);
            shippingElement.textContent = formatCurrency(shippingCost);
            totalPriceElement.textContent = formatCurrency(finalTotal);
            
            // Add event listeners
            addCartEventListeners();
        }

        // Add Event Listeners to Cart Items
        function addCartEventListeners() {
            // Remove item buttons
            document.querySelectorAll('.remove-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    removeFromCart(productId);
                });
            });

            // Increase quantity buttons
            document.querySelectorAll('.increase-qty').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    updateQuantity(productId, 1);
                });
            });

            // Decrease quantity buttons
            document.querySelectorAll('.decrease-qty').forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.getAttribute('data-id');
                    const input = document.querySelector(`.qty-input[data-id="${productId}"]`);
                    if (parseInt(input.value) > 1) {
                        updateQuantity(productId, -1);
                    } else {
                        removeFromCart(productId);
                    }
                });
            });
        }

        // Remove Item from Cart
        async function removeFromCart(productId) {
            if (!checkAuth()) return;
            
            showLoading();
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/cart/remove/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to remove item from cart');
                }

                // Refresh cart after removing item
                fetchCart();
                showToast('Item removed from cart', 'success');
            } catch (error) {
                console.error('Error removing item from cart:', error);
                showToast('Error removing item. Please try again.', 'danger');
                hideLoading();
            }
        }

        // Clear Cart
        async function clearCart() {
            if (!checkAuth()) return;
            
            showLoading();
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/cart/clear`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to clear cart');
                }

                fetchCart();
                showToast('Cart cleared successfully', 'success');
            } catch (error) {
                console.error('Error clearing cart:', error);
                showToast('Error clearing cart. Please try again.', 'danger');
                hideLoading();
            }
        }

        // Update Item Quantity
        async function updateQuantity(productId, change) {
            if (!checkAuth()) return;
            
            showLoading();
            try {
                const token = localStorage.getItem('token');
                // First, remove the current item
                const removeResponse = await fetch(`${API_BASE_URL}/cart/remove/${productId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!removeResponse.ok) {
                    throw new Error('Failed to update quantity');
                }

                // Then, add it with the new quantity
                const currentInput = document.querySelector(`.qty-input[data-id="${productId}"]`);
                const currentQty = parseInt(currentInput.value);
                const newQty = currentQty + change;

                // Add the item back with new quantity
                for (let i = 0; i < newQty; i++) {
                    const addResponse = await fetch(`${API_BASE_URL}/cart/add/${productId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });

                    if (!addResponse.ok) {
                        throw new Error('Failed to update quantity');
                    }
                }

                // Refresh cart after updating
                fetchCart();
            } catch (error) {
                console.error('Error updating quantity:', error);
                showToast('Error updating quantity. Please try again.', 'danger');
                hideLoading();
            }
        }

        // Update Cart Count Badge
        function updateCartCount(count) {
            cartCountElement.textContent = count;
        }

        // Toast Notification Function
        function showToast(message, type = 'info') {
            const toastContainer = document.createElement('div');
            toastContainer.style.position = 'fixed';
            toastContainer.style.top = '20px';
            toastContainer.style.right = '20px';
            toastContainer.style.zIndex = '1050';
            
            const toast = document.createElement('div');
            toast.className = `toast show bg-${type} text-white`;
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            
            toast.innerHTML = `
                <div class="toast-header bg-${type} text-white">
                    <strong class="me-auto">Notification</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
                <div class="toast-body">
                    ${message}
                </div>
            `;
            
            toastContainer.appendChild(toast);
            document.body.appendChild(toastContainer);
            
            // Auto-hide after 3 seconds
            setTimeout(() => {
                toastContainer.remove();
            }, 3000);
            
            // Close on button click
            toast.querySelector('.btn-close').addEventListener('click', () => {
                toastContainer.remove();
            });
        }

        // Checkout Button Event
        checkoutBtn.addEventListener('click', function() {
            // For now, redirect to checkout page
            window.location.href = 'checkout.html';
        });

        // Initialize Page
        document.addEventListener('DOMContentLoaded', function() {
            fetchCart();
        });
    </script>
</body>
</html>